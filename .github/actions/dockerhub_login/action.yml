name: "DockerHub Login"
description: "Login to Dockerhub and prepare signing key"
inputs:
  login:
    description: "Dockerhub Username"
    required: true
  password:
    description: "Dockerhub Password"
    required: true
  key_material:
    description: "Base64 encoded key file contents"
    required: false
  key_name:
    description: "The name of the base64 encoded key as generated by docker"
    required: false
  key_password:
    description: "The password for the base64 encoded key"
    required: false
runs:
  using: "composite"
  steps:
    - run: |
        echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
        mkdir -p ~/.docker/trust/private/
        echo ${DOCKERHUB_KEY_MATERIAL} | base64 -d > ~/.docker/trust/private/${DOCKERHUB_KEY_NAME}.key
        chmod 600 ~/.docker/trust/private/${DOCKERHUB_KEY_NAME}.key
        docker trust key load ~/.docker/trust/private/${DOCKERHUB_KEY_NAME}.key --name "$DOCKERHUB_USERNAME"
        echo Docker hub is logged in, and signing is available.
      shell: bash
      env:
        DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE: ${{ inputs.key_password }}
        DOCKERHUB_USERNAME: ${{ inputs.username }}
        DOCKERHUB_PASSWORD: ${{ inputs.password }}
        DOCKERHUB_KEY_MATERIAL: ${{ inputs.key_material }}
        DOCKERHUB_KEY_NAME: ${{ inputs.key_name }}
